<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Kapasitas Gudang - Utilisasi Warehouse Yogya</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family:'Segoe UI',Tahoma,sans-serif; 
      margin:0; 
      background:#eef2f7; 
      min-height:100vh;
    }

    header {
      display:flex; 
      align-items:center; 
      justify-content:flex-start;
      background: linear-gradient(90deg,  #fff 10%, #2c3e50 100%); 
      padding:15px 20px; 
      color:#2c3e50; 
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      gap: 30px;
    }
    
    .logo { 
      display:flex; 
      align-items:center; 
      flex-shrink:0; 
    }
    
    .logo img { 
      width:100px; 
      height:50px; 
      margin-right:15px; 
      border-radius:8px; 
    }
    
    .logo-text { 
      display:flex; 
      flex-direction:column; 
      line-height:1.3; 
    }
    
    .logo-text strong { 
      font-size:18px; 
      color:#2c3e50;
    }
    
    .logo-text span { 
      font-size:14px; 
      opacity:0.7; 
      color:#7f8c8d;
    }
    
    .controls { 
      display:flex; 
      gap:10px; 
      align-items:center; 
      flex-wrap:wrap; 
    }
    
    button.ctrl { 
      padding:8px 15px; 
      border:none; 
      border-radius:6px; 
      cursor:pointer; 
      font-size:13px; 
      color:white; 
      font-weight:500;
      transition:all 0.3s ease;
    }
    
    button.ctrl:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .export{background:#27ae60;} 
    .print{background:#2980b9;} 
    .refresh{background:#f39c12;}
    .back{background:#8e44ad;} /* Purple color for back button */
    
    .status { 
      display:flex; 
      align-items:center; 
      font-size:12px; 
      margin-left:15px; 
    }
    
    .status span { 
      width:10px; 
      height:10px; 
      border-radius:50%; 
      display:inline-block; 
      margin-right:6px; 
    }
    
    .connected{background:#2ecc71;} 
    .disconnected{background:#e74c3c;} 
    .loading{background:#f1c40f;}

    /* Navigation breadcrumb */
    .breadcrumb {
      margin: 0 20px 10px 20px;
      padding: 10px 15px;
      background: linear-gradient(90deg,  #8e44ad 20%, #000 100%); 
      border-radius: 8px;
      font-size: 14px;
      color: #000;
      border-left: 4px solid #3498db;
    }
    
    .breadcrumb a {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
    }
    
    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .filters{
      margin:0 20px 20px 20px;
      display:flex;
      gap:15px;
      flex-wrap:wrap;
      align-items:center;
    }
    
    input[type=text]{
      padding:10px 12px;
      border:1px solid #bdc3c7;
      border-radius:8px;
      flex:1; 
      background:#ffffff;
      font-size:14px;
      min-width:250px;
    }
    
    input[type=text]:focus {
      outline:none;
      border-color:#3498db;
      box-shadow:0 0 0 3px rgba(52,152,219,0.1);
    }
    
    select{
      padding:10px 12px;
      border-radius:8px;
      background:#ffffff;
      border:1px solid #bdc3c7;
      font-size:14px;
      min-width:150px;
    }
    
    /* Chart section */
    .charts { 
      display:flex; 
      flex-wrap:wrap; 
      gap:20px; 
      margin:0 20px 20px 20px; 
    }
    
    .chart-card { 
      background:white; 
      border-radius:12px; 
      padding:20px; 
      flex:1; 
      min-width:300px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1); 
      text-align:center; 
    }
    
    .chart-card h4 { 
      margin-bottom:15px; 
      font-size:16px; 
      color:#2c3e50; 
      font-weight:600;
    }
    
    canvas { 
      max-height:250px !important; 
    }
    
    /* Tabel */
    .table-container{
      margin:0 20px 20px 20px;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      overflow-x:auto;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    
    th,td{
      border:1px solid #e8e8e8;
      padding:12px 8px;
      text-align:left;
    }
    
    th{
      background:#34495e;
      color:white;
      cursor:pointer;
      font-weight:600;
      position:sticky;
      top:0;
      z-index:10;
    }
    
    th:hover {
      background:#2c3e50;
    }
    
    th.sorted-asc::after{content:" ‚ñ≤";} 
    th.sorted-desc::after{content:" ‚ñº";}
    
    tr:nth-child(even){background:#f8f9fa;}
    tr:hover { background:#e3f2fd; }
    tr.selected { background:#bbdefb !important; border-left: 4px solid #2196f3; }
    
    .totals{
      margin-top:15px;
      font-weight:bold;
      font-size:14px;
      text-align:right;
      color:#2c3e50;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }
      
      input[type=text], select {
        min-width: 100%;
      }
      
      .controls {
        flex-wrap: wrap;
      }
      
      .logo-text strong {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Main Content -->
  <div class="main" id="main">
    <header>
      <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
        <div class="logo-text">
          <strong>Data Kapasitas Gudang</strong>
          <span>Laporan Kapasitas dan Utilisasi Gudang</span>
        </div>
      </div>
      <div class="controls">
        <button class="ctrl back" onclick="goBackToDashboard()" title="Kembali ke Dashboard Utama">‚Üê Dashboard</button>
        <button class="ctrl export" onclick="exportTable()">‚¨á Export</button>
        <button class="ctrl print" onclick="printTable()">üñ® Print</button>
        <button class="ctrl refresh" onclick="loadSheet()">üîÑ Refresh Data</button>
        <div class="status" id="status">
          <span class="disconnected"></span><span id="statusText">Disconnected</span>
        </div>
      </div>
    </header>
    
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb" id="breadcrumb">
      <a href="#" onclick="goBackToDashboard()">Dashboard Utama</a> > Data Kapasitas Gudang
    </div>
    
    <!-- Mini Charts -->
    <div class="charts">
      <div class="chart-card">
        <h4>Kapasitas Gudang (%)</h4>
        <canvas id="capacityChart"></canvas>
      </div>
      <div class="chart-card">
        <h4>Stock and Empty Racking Report</h4>
        <canvas id="rackingChart"></canvas>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input type="text" id="searchBox" placeholder="üîç Search..." oninput="applyFilters()">
      <select id="filterC" onchange="applyFilters()"><option value="">-- Filter --</option></select>
    </div>

    <!-- Main Table -->
    <div class="table-container">
      <table id="sheetTable"><thead></thead><tbody></tbody></table>
    </div>
  </div>

<script>
// Google Sheets API Configuration
let apiKey = 'AIzaSyD3nhZyvd7npQw6n9mPXxOA6svJdo_JQis';
let spreadsheetId = '1ngP7PTE4mNKtkcTQU5sRYswdYmdC401M4ioxxkt-Hxw';
let sheetName = 'KAPASITAS GD'; // Capacity Data sheet

let allRows = [];
let currentSort = { index: -1, asc: true };
let capacityChart, rackingChart;

// Function to get dashboard URL from various sources
function getDashboardUrl() {
  console.log('Current URL:', window.location.href);
  console.log('Current Path:', window.location.pathname);
  console.log('Referrer:', document.referrer);
  
  // Try to get dashboard URL from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const returnUrl = urlParams.get('return');
  if (returnUrl) {
    console.log('Using return URL:', returnUrl);
    return decodeURIComponent(returnUrl);
  }
  
  // Try to get from document referrer
  if (document.referrer && document.referrer !== window.location.href) {
    console.log('Using referrer URL:', document.referrer);
    return document.referrer;
  }
  
  // For GitHub Pages - specific URLs
  const githubPagesUrls = [
    'https://riep31.github.io/UtilisasiWarehouse/dashboard.html',
    '/UtilisasiWarehouse/dashboard.html',
    './dashboard.html',
    '../dashboard.html'
  ];
  
  console.log('Trying dashboard URLs:', githubPagesUrls);
  return githubPagesUrls[0];
}

// Navigation function - Fixed to be properly global
function goBackToDashboard() {
  console.log('Going back to dashboard...');
  
  try {
    // Method 1: Use referrer if available and valid
    if (document.referrer && 
        document.referrer !== window.location.href && 
        document.referrer.includes('dashboard.html')) {
      console.log('Using referrer method');
      window.location.href = document.referrer;
      return;
    }
    
    // Method 2: Use browser history if available
    if (window.history.length > 1) {
      console.log('Using history back method');
      window.history.back();
      return;
    }
    
    // Method 3: Navigate to specific dashboard URL
    const dashboardUrl = getDashboardUrl();
    console.log('Using direct navigation to:', dashboardUrl);
    if (dashboardUrl) {
      window.location.href = dashboardUrl;
    } else {
      // Method 4: Fallback options
      console.log('Using fallback method');
      if (confirm('Tidak dapat menemukan dashboard. Apakah ingin ke halaman utama?')) {
        window.location.href = 'https://riep31.github.io/UtilisasiTes/';
      }
    }
  } catch (error) {
    console.error('Error in goBackToDashboard:', error);
    // Final fallback
    if (confirm('Terjadi error saat navigasi. Apakah ingin ke halaman utama?')) {
      window.location.href = 'https://riep31.github.io/UtilisasiTes/';
    }
  }
}

// Update page title and breadcrumb based on referrer or URL params
function updateNavigationContext() {
  const urlParams = new URLSearchParams(window.location.search);
  const returnUrl = urlParams.get('return');
  const returnName = urlParams.get('returnName') || 'Dashboard Utama';
  
  if (returnUrl || document.referrer) {
    const breadcrumb = document.getElementById('breadcrumb');
    breadcrumb.innerHTML = `<a href="#" onclick="goBackToDashboard()">${returnName}</a> > Data Kapasitas Gudang`;
  }
}

// Google Sheets API function to fetch data
async function fetchSheetData(sheetNameParam) {
  if (!apiKey || !spreadsheetId) {
    throw new Error('API key or spreadsheet ID not configured');
  }
  
  const range = `${sheetNameParam}!A:Z`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
  
  const response = await fetch(url);
  
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`Google Sheets API Error: ${errorData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  return data.values || [];
}

// Load sheet function
async function loadSheet() {
  if (!apiKey || apiKey === 'YOUR_API_KEY_HERE') {
    setStatus("disconnected", "API Key belum dikonfigurasi");
    return;
  }
  
  setStatus("loading","Loading...");
  try {
    const mainSheetData = await fetchSheetData(sheetName);
    allRows = mainSheetData;
    renderTable(allRows);
    fillFilter(allRows);
    updateCharts(allRows);
    setStatus("connected","Connected");
  } catch(error) {
    console.error('Error loading sheet:', error);
    setStatus("disconnected","Error: " + error.message);
  }
}

// Render table function
function renderTable(rows){
  let thead = document.querySelector("#sheetTable thead");
  let tbody = document.querySelector("#sheetTable tbody");
  thead.innerHTML = ""; 
  tbody.innerHTML = "";
  
  if(rows.length === 0) return;
  
  let header = document.createElement("tr");
  rows[0].forEach((h,i) => {
    let th = document.createElement("th"); 
    th.textContent = h;
    th.onclick = () => sortTable(i);
    if(currentSort.index === i) th.classList.add(currentSort.asc ? "sorted-asc" : "sorted-desc");
    header.appendChild(th);
  }); 
  thead.appendChild(header);
  
  rows.slice(1).forEach((r,index) => {
    let tr = document.createElement("tr");
    r.forEach((c,i) => {
      let td = document.createElement("td"); 
      td.textContent = c;
      tr.appendChild(td);
    });
    
    // Add click functionality to highlight selected row
    tr.onclick = () => {
      document.querySelectorAll("#sheetTable tbody tr").forEach(row => row.classList.remove("selected"));
      tr.classList.add("selected");
      
      // Update charts with selected row data
      updateCharts([rows[0], r]);
      updateRackingChart(r);
    };
    
    tbody.appendChild(tr);
  });
}

// Sort table function
function sortTable(i){
  let rows = [...allRows]; 
  if(i === currentSort.index) currentSort.asc = !currentSort.asc; 
  else currentSort = {index: i, asc: true};
  let header = rows.shift();
  rows.sort((a,b) => {
    let va = a[i], vb = b[i]; 
    let na = parseFloat(va), nb = parseFloat(vb);
    if(!isNaN(na) && !isNaN(nb)) return currentSort.asc ? na-nb : nb-na;
    return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
  });
  let sortedRows = [header, ...rows];
  renderTable(sortedRows);
}

// Apply filters function
function applyFilters(){
  let search = document.getElementById("searchBox").value.toLowerCase();
  let fC = document.getElementById("filterC").value;
  let filtered = allRows.filter((r,i) => {
    if(i === 0) return true;
    let s = r.some(c => c.toLowerCase().includes(search));
    let mC = !fC || r[1] === fC;
    return s && mC;
  });
  renderTable(filtered);
  updateCharts(filtered);
}

// Fill filter function
function fillFilter(rows){
  let sc = document.getElementById("filterC");
  sc.innerHTML = "<option value=''>-- Filter --</option>";
  let vals = [...new Set(rows.slice(1).map(r => r[1]))];
  vals.forEach(v => {
    if(v){
      let o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      sc.appendChild(o);
    }
  });
}

// Export table function
function exportTable() { 
  let csv = Papa.unparse(allRows); 
  let blob = new Blob([csv], {type: "text/csv"}); 
  let url = URL.createObjectURL(blob); 
  let a = document.createElement("a"); 
  a.href = url; 
  a.download = "capacity_data.csv"; 
  a.click(); 
  URL.revokeObjectURL(url);
}

// Print table function
function printTable() { 
  window.print(); 
}

// Set status function
function setStatus(st, t){ 
  let span = document.querySelector("#status span"); 
  span.className = st === "connected" ? "connected" : st === "loading" ? "loading" : "disconnected"; 
  document.getElementById("statusText").textContent = t; 
}

// Chart functions
function updateCharts(rows){
  if(rows.length < 2) return;
  let headers = rows[0];
  let locIdx = headers.indexOf("Warehouse Location");
  let stockedIdx = headers.indexOf("Stocked Racking Percent");
  let emptyIdx = headers.indexOf("Empty Racking Percent");
  if(locIdx < 0 || stockedIdx < 0 || emptyIdx < 0) return;
  
  let labels = [];
  let stocked = [];
  let empty = [];
  
  rows.slice(1).forEach(r => {
    labels.push(r[locIdx]);
    stocked.push(parseFloat(r[stockedIdx] || 0));
    empty.push(parseFloat(r[emptyIdx] || 0));
  });
  
  if(capacityChart) capacityChart.destroy();
  capacityChart = new Chart(document.getElementById("capacityChart"), {
    type: "bar",
    data: { 
      labels, 
      datasets: [
        { label: "Stocked %", data: stocked, backgroundColor: "#3498db" },
        { label: "Empty %", data: empty, backgroundColor: "#95a5a6" }
      ]
    },
    options: { 
      responsive: true, 
      plugins: {legend: {position: "bottom"}}, 
      scales: {x: {stacked: true}, y: {stacked: true, max: 100}} 
    }
  });
  updateRackingChart();
}

function updateRackingChart(selectedRow = null){
  if(allRows.length < 2) return;
  
  let stockedData = [];
  let emptyData = [];
  
  if(selectedRow) {
    // Use data from selected row only
    let stockedVal = parseFloat(selectedRow[2] || 0); // Column C - Stocked values
    let emptyVal = parseFloat(selectedRow[3] || 0);   // Column D - Empty values
    stockedData.push(stockedVal);
    emptyData.push(emptyVal);
  } else {
    // Use data from all rows (default behavior)
    allRows.slice(1).forEach(r => {
      let stockedVal = parseFloat(r[2] || 0); // Column C - Stocked values
      let emptyVal = parseFloat(r[3] || 0);   // Column D - Empty values
      stockedData.push(stockedVal);
      emptyData.push(emptyVal);
    });
  }
  
  // Calculate total values
  let totalStocked = stockedData.reduce((a,b) => a+b, 0);
  let totalEmpty = emptyData.reduce((a,b) => a+b, 0);
  
  if(rackingChart) rackingChart.destroy();
  rackingChart = new Chart(document.getElementById("rackingChart"), {
    type: "doughnut",
    data: { 
      labels: ["Stocked","Empty"], 
      datasets: [{ 
        data: [totalStocked, totalEmpty], 
        backgroundColor: ["#27ae60","#e74c3c"] 
      }] 
    },
    options: { 
      responsive: true, 
      plugins: {
        legend: {position: "bottom"},
        tooltip: {
          callbacks: {
            label: function(context) {
              let total = totalStocked + totalEmpty;
              let percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
              return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  updateNavigationContext();
  loadSheet();
});

// Make functions globally accessible
window.goBackToDashboard = goBackToDashboard;
window.loadSheet = loadSheet;
window.applyFilters = applyFilters;
window.exportTable = exportTable;
window.printTable = printTable;
</script>
</body>
</html>
