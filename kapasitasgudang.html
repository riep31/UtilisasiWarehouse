<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Kapasitas Gudang - Utilisasi Warehouse Yogya</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family:'Inter', 'Segoe UI', Tahoma, sans-serif; 
      margin:0; 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height:100vh;
    }

    header {
      display:flex; 
      align-items:center; 
      justify-content:flex-start;
      background: linear-gradient(90deg,  #fff 10%, #2c3e50 100%);
      padding:20px 20px; 
      color:#2c3e50; 
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      gap: 40px;
      border-bottom: 1px solid rgba(52, 73, 94, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .logo { 
      display:flex; 
      align-items:center; 
      flex-shrink:0; 
    }
    
    .logo img { 
      width:110px; 
      height:55px; 
      margin-right:20px; 
      border-radius:12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }
    
    .logo img:hover {
      transform: scale(1.05);
    }
    
    .logo-text { 
      display:flex; 
      flex-direction:column; 
      line-height:1.3; 
    }
    
    .logo-text strong { 
      font-size:22px; 
      color:#2c3e50;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .logo-text span { 
      font-size:15px; 
      opacity:0.8; 
      color:#6c757d;
      font-weight: 400;
    }
    
    .controls { 
      display:flex; 
      gap:10px; 
      align-items:center; 
      flex-wrap:wrap; 
    }
    
    button.ctrl { 
      padding:12px 20px; 
      border:none; 
      border-radius:10px; 
      cursor:pointer; 
      font-size:14px; 
      color:white; 
      font-weight:600;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    button.ctrl::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    button.ctrl:hover::before {
      left: 100%;
    }
    
    button.ctrl:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .export{background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);} 
    .print{background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);} 
    .refresh{background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);}
    .back{background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);}
    
    .status { 
      display:flex; 
      align-items:center; 
      font-size:12px; 
      margin-left:15px; 
    }
    
    .status span { 
      width:10px; 
      height:10px; 
      border-radius:50%; 
      display:inline-block; 
      margin-right:6px; 
    }
    
    .connected{background:#2ecc71;} 
    .disconnected{background:#e74c3c;} 
    .loading{background:#f1c40f;}

    /* Enhanced Navigation breadcrumb */
    .breadcrumb {
      margin: 0 30px 15px 30px;
      padding: 14px 21px;
      background: linear-gradient(135deg,#f5f5f5 0%, #dcdcdc 30%, #b0b0b0 70%, #707070 100%);
      border-radius: 15px;
      font-size: 15px;
      color: #495057;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .breadcrumb::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 30%, transparent 50%);
      pointer-events: none;
    }
    
    .breadcrumb-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1;
      position: relative;
    }
    
    .breadcrumb-nav .home-icon {
      font-size: 16px;
      margin-right: 5px;
    }
    
    .breadcrumb a {
      color: #495057;
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: rgba(108, 117, 125, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .breadcrumb a:hover {
      background: rgba(108, 117, 125, 0.5);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      color: #2c3e50;
    }
    
    .breadcrumb-separator {
      color: #6c757d;
      margin: 0 5px;
      font-weight: bold;
    }
    
    .breadcrumb-current {
      color: #2c3e50;
      font-weight: bold;
      text-shadow: none;
    }
    
    .breadcrumb-date {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 13px;
      z-index: 1;
      position: relative;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      padding: 10px 15px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(44, 62, 80, 0.3);
      color: #495057;
      box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
    }
    
    .breadcrumb-date .date-main {
      font-weight: bold;
      font-size: 15px;
      margin-bottom: 2px;
      color: white;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .breadcrumb-date .date-day {
      opacity: 1;
      font-size: 13px;
      text-transform: capitalize;
      color: white;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .filters{
      margin:0 30px 18px 30px;
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      align-items:center;
      background: rgba(255, 255, 255, 0.7);
      padding: 12px 21px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    input[type=text]{
      padding:15px 20px;
      border:2px solid rgba(52, 73, 94, 0.1);
      border-radius:12px;
      flex:1; 
      background: rgba(255, 255, 255, 0.9);
      font-size:15px;
      min-width:280px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    input[type=text]:focus {
      outline:none;
      border-color:#3498db;
      box-shadow:0 0 0 4px rgba(52,152,219,0.2);
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 1);
    }
    
    select{
      padding:15px 18px;
      border-radius:12px;
      background: rgba(255, 255, 255, 0.9);
      border:2px solid rgba(52, 73, 94, 0.1);
      font-size:15px;
      min-width:180px;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 4px rgba(52,152,219,0.2);
      transform: translateY(-2px);
    }

    /* Charts Container */
    .charts-container {
      margin: 0 30px 30px 30px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .chart-box {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .chart-box h3 {
      margin: 0 0 25px 0;
      color: #2c3e50;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
    }

    .chart-container {
      position: relative;
      height: 400px;
    }

    /* Table Container */
    .table-container{
      margin:0 30px 30px 30px;
      background: rgba(255, 255, 255, 0.95);
      padding:21px;
      border-radius:20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow-x:auto;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    td{
      border:1px solid rgba(52, 73, 94, 0.1);
      padding:16px 12px;
      text-align:left;
    }
    
    th {
      border: 1px solid rgba(52, 73, 94, 0.1);
      padding: 16px 12px;
      text-align: left;
      background: #2c3e50;
      color: white;
      cursor: pointer;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 13px;
    }

    th.sorted-asc::after { content: " ▲"; } 
    th.sorted-desc::after { content: " ▼"; }

    tr:nth-child(even) { 
      background: rgba(248, 249, 250, 0.8); 
    }

    tbody tr:hover { 
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
      transform: scale(1.01);
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    tr.selected { 
      background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%) !important; 
      border-left: 5px solid #2196f3; 
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    /* Subtotal Styles */
    .subtotals {
      margin-top: 25px;
      padding: 21px;
      background: rgba(108, 117, 125, 0.2);
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(8px);
      border-radius: 15px;
    }

    .subtotals h4 {
      margin: 0 0 20px 0;
      color: #212529;
      font-size: 18px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .subtotal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px; 
      border-bottom: 1px solid rgba(73, 80, 87, 0.25);
      font-weight: bold;
      color: #343a40;
      transition: background 0.3s ease, box-shadow 0.3s ease, text-shadow 0.3s ease;
      border-radius: 10px;
    }

    .subtotal-row:hover {
      background: rgba(52, 152, 219, 0.2);
    }

    .subtotal-row:last-child {
      border-bottom: none;
    }

    .subtotal-label {
      font-weight: 700;
      font-size: 15px;
    }

    .subtotal-value {
      color: #212529;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace;
      font-size: 16px;
      font-weight: bold;
      background: rgba(52, 58, 64, 0.15);
      padding: 8px 15px;
      border-radius: 8px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .breadcrumb {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
        padding: 15px;
      }
      
      .breadcrumb-date {
        align-self: flex-end;
        margin-top: 10px;
      }
      
      .filters {
        flex-direction: column;
      }
      
      input[type=text], select {
        min-width: 100%;
      }
      
      .controls {
        flex-wrap: wrap;
      }
      
      .logo-text strong {
        font-size: 14px;
      }

      .charts-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="main" id="main">
    <header>
      <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
        <div class="logo-text">
          <strong>Data Kapasitas Gudang</strong>
          <span>Utilisasi Warehouse Yogya</span>
        </div>
      </div>
      <div class="controls">
        <button class="ctrl back" onclick="goBackToDashboard()">← Dashboard</button>
        <button class="ctrl export" onclick="exportTable()">⬇ Export</button>
        <button class="ctrl print" onclick="printTable()">🖨 Print</button>
        <button class="ctrl refresh" onclick="loadSheet()">🔄 Refresh Data</button>
        <div class="status" id="status">
          <span class="disconnected"></span><span id="statusText">Disconnected</span>
        </div>
      </div>
    </header>

    <div class="breadcrumb">
      <div class="breadcrumb-nav">
        <span class="home-icon">🏠</span>
        <a href="#" onclick="goBackToDashboard()">Dashboard Utama</a>
        <span class="breadcrumb-separator">›</span>
        <span class="breadcrumb-current">Data Kapasitas Gudang</span>
      </div>
      <div class="breadcrumb-date">
        <div class="date-main" id="currentDate">Loading...</div>
        <div class="date-day" id="currentDay">Loading...</div>
      </div>
    </div>

    <div class="filters">
      <input type="text" id="searchBox" placeholder="🔍 Search..." oninput="applyFilters()">
      <select id="filterC" onchange="applyFilters()"><option value="">-- Pilih Lokasi Gudang --</option></select>
    </div>

    <div class="charts-container" id="chartsContainer">
      <div class="chart-box">
        <h3>Racking Status Overview</h3>
        <div class="chart-container">
          <canvas id="capacityChart"></canvas>
        </div>
      </div>
      <div class="chart-box">
        <h3>Utilisasi per Lokasi</h3>
        <div class="chart-container">
          <canvas id="rackingChart"></canvas>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table id="sheetTable"><thead></thead><tbody></tbody></table>
      
      <div class="subtotals">
        <h4>📊 Ringkasan Data</h4>
        <div class="subtotal-row">
          <span class="subtotal-label">Total Stocked Racking:</span>
          <span class="subtotal-value" id="subtotalStocked">0</span>
        </div>
        <div class="subtotal-row">
          <span class="subtotal-label">Total Empty Racking:</span>
          <span class="subtotal-value" id="subtotalEmpty">0</span>
        </div>
      </div>
    </div>
  </div>

<script>
// Google Sheets API Configuration
let apiKey = 'AIzaSyD3nhZyvd7npQw6n9mPXxOA6svJdo_JQis';
let spreadsheetId = '1ngP7PTE4mNKtkcTQU5sRYswdYmdC401M4ioxxkt-Hxw';
let sheetName = 'KAPASITAS GD';

let allRows = [];
let currentSort = { index: -1, asc: true };
let capacityChart, rackingChart;
let selectedRowIndex = -1;

function updateBreadcrumbDate() {
  const now = new Date();
  const dayNames = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
  const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  
  const dayName = dayNames[now.getDay()];
  const day = now.getDate();
  const month = monthNames[now.getMonth()];
  const year = now.getFullYear();
  
  document.getElementById('currentDate').innerHTML = `📅 ${day} ${month} ${year}`;
  document.getElementById('currentDay').innerHTML = dayName;
}

function goBackToDashboard() {
  try {
    if (document.referrer && document.referrer !== window.location.href && document.referrer.includes('dashboard.html')) {
      window.location.href = document.referrer;
      return;
    }
    if (window.history.length > 1) {
      window.history.back();
      return;
    }
    window.location.href = 'https://riep31.github.io/UtilisasiWarehouse/dashboard.html';
  } catch (error) {
    console.error('Navigation error:', error);
    window.location.href = 'https://riep31.github.io/UtilisasiTes/';
  }
}

async function fetchSheetData(sheetNameParam) {
  if (!apiKey || !spreadsheetId) {
    throw new Error('API key atau spreadsheet ID tidak dikonfigurasi');
  }
  
  const range = `${sheetNameParam}!A:Z`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
  
  try {
    const response = await fetch(url);
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`Google Sheets API Error: ${errorData.error?.message || response.statusText}`);
    }
    const data = await response.json();
    return data.values || [];
  } catch (error) {
    console.error('Fetch error:', error);
    throw error;
  }
}

function calculateSubtotals(rows) {
  if (rows.length <= 1) return { subtotalStocked: 0, subtotalEmpty: 0 };
  
  let totalStocked = 0, totalEmpty = 0;
  
  rows.slice(1).forEach(row => {
    if (row.length > 2) {
      // Kolom C (index 2) untuk Stocked Racking
      const stockedValue = parseFloat(row[2]) || 0;
      totalStocked += stockedValue;
      
      // Kolom D (index 3) untuk Empty Racking
      if (row.length > 3) {
        const emptyValue = parseFloat(row[3]) || 0;
        totalEmpty += emptyValue;
      }
    }
  });
  
  return { subtotalStocked: totalStocked, subtotalEmpty: totalEmpty };
}

function updateSubtotals(rows) {
  const subtotals = calculateSubtotals(rows);
  document.getElementById('subtotalStocked').textContent = subtotals.subtotalStocked.toLocaleString('id-ID');
  document.getElementById('subtotalEmpty').textContent = subtotals.subtotalEmpty.toLocaleString('id-ID');
}

function createCharts(rows, selectedRow = null) {
  if (rows.length <= 1) return;
  
  // Destroy existing charts
  if (capacityChart) {
    capacityChart.destroy();
  }
  if (rackingChart) {
    rackingChart.destroy();
  }

  let dataToUse = rows.slice(1);
  let chartTitle1 = 'Racking Status Overview';
  let chartTitle2 = 'Utilisasi per Lokasi';
  
  // Jika ada baris yang dipilih, gunakan data baris tersebut
  if (selectedRow && selectedRow.length > 0) {
    dataToUse = [selectedRow];
    chartTitle1 = `Racking Status - ${selectedRow[0] || 'Selected'}`;
    chartTitle2 = `Utilisasi - ${selectedRow[0] || 'Selected'}`;
    
    // Update chart titles
    document.querySelector('.chart-box h3').textContent = chartTitle1;
    document.querySelectorAll('.chart-box h3')[1].textContent = chartTitle2;
  } else {
    // Reset chart titles
    document.querySelector('.chart-box h3').textContent = 'Racking Status Overview';
    document.querySelectorAll('.chart-box h3')[1].textContent = 'Utilisasi per Lokasi';
  }
  
  const labels = [];
  const stockedData = [];
  const emptyData = [];
  const utilizationData = [];
  
  dataToUse.forEach((row, index) => {
    if (row.length > 0) {
      labels.push(row[0] || `Area ${index + 1}`);
      
      // Kolom C (index 2) - Stocked Racking
      const stocked = parseFloat(row[2]) || 0;
      stockedData.push(stocked);
      
      // Kolom D (index 3) - Empty Racking
      const empty = parseFloat(row[3]) || 0;
      emptyData.push(empty);
      
      // Hitung utilisasi (stocked / (stocked + empty) * 100)
      const total = stocked + empty;
      const utilization = total > 0 ? (stocked / total * 100) : 0;
      utilizationData.push(utilization);
    }
  });

  // Capacity Chart (Bar Chart untuk Stocked vs Empty)
  const capacityCtx = document.getElementById('capacityChart').getContext('2d');
  capacityChart = new Chart(capacityCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Stocked Racking',
          data: stockedData,
          backgroundColor: 'rgba(46, 204, 113, 0.8)',
          borderColor: 'rgba(46, 204, 113, 1)',
          borderWidth: 2
        },
        {
          label: 'Empty Racking',
          data: emptyData,
          backgroundColor: 'rgba(231, 76, 60, 0.8)',
          borderColor: 'rgba(231, 76, 60, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            font: {
              size: 14,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.raw.toLocaleString('id-ID')}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 12,
              weight: 'bold'
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.1)'
          },
          ticks: {
            font: {
              size: 12
            },
            callback: function(value) {
              return value.toLocaleString('id-ID');
            }
          }
        }
      }
    }
  });

  // Utilization Chart (Doughnut Chart)
  const rackingCtx = document.getElementById('rackingChart').getContext('2d');
  
  // Jika ada baris yang dipilih, gunakan data dari kolom E dan F
  if (selectedRow && selectedRow.length > 5) {
    const stockedPercent = parseFloat(selectedRow[4]) || 0; // Kolom E (index 4)
    const emptyPercent = parseFloat(selectedRow[5]) || 0;   // Kolom F (index 5)
    
    rackingChart = new Chart(rackingCtx, {
      type: 'doughnut',
      data: {
        labels: ['Stocked Racking %', 'Empty Racking %'],
        datasets: [{
          label: 'Persentase Racking',
          data: [stockedPercent, emptyPercent],
          backgroundColor: [
            'rgba(46, 204, 113, 0.8)',
            'rgba(231, 76, 60, 0.8)'
          ],
          borderColor: [
            'rgba(46, 204, 113, 1)',
            'rgba(231, 76, 60, 1)'
          ],
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw.toFixed(1)}%`;
              }
            }
          }
        }
      }
    });
  } else {
    // Tampilan default untuk semua data (utilisasi berdasarkan perhitungan)
    rackingChart = new Chart(rackingCtx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          label: 'Utilisasi (%)',
          data: utilizationData,
          backgroundColor: [
            'rgba(46, 204, 113, 0.8)',
            'rgba(52, 152, 219, 0.8)',
            'rgba(155, 89, 182, 0.8)',
            'rgba(241, 196, 15, 0.8)',
            'rgba(231, 76, 60, 0.8)',
            'rgba(243, 156, 18, 0.8)',
            'rgba(26, 188, 156, 0.8)',
            'rgba(142, 68, 173, 0.8)'
          ],
          borderColor: [
            'rgba(46, 204, 113, 1)',
            'rgba(52, 152, 219, 1)',
            'rgba(155, 89, 182, 1)',
            'rgba(241, 196, 15, 1)',
            'rgba(231, 76, 60, 1)',
            'rgba(243, 156, 18, 1)',
            'rgba(26, 188, 156, 1)',
            'rgba(142, 68, 173, 1)'
          ],
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                size: 12,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `${context.label}: ${context.raw.toFixed(1)}%`;
              }
            }
          }
        }
      }
    });
  }
}

async function loadSheet() {
  setStatus("loading", "Memuat data...");
  
  try {
    const data = await fetchSheetData(sheetName);
    
    if (data.length === 0) {
      throw new Error('Data tidak ditemukan atau sheet kosong');
    }
    
    allRows = data;
    renderTable(allRows);
    fillFilter(allRows);
    updateSubtotals(allRows);
    createCharts(allRows);
    setStatus("connected", "Data berhasil dimuat");
    
  } catch (error) {
    console.error('Error loading sheet:', error);
    setStatus("disconnected", "Error: " + error.message);
    
    // Show error message in table
    const tbody = document.querySelector("#sheetTable tbody");
    tbody.innerHTML = `<tr><td colspan="100%" style="text-align:center;color:#e74c3c;padding:50px;">Error: ${error.message}</td></tr>`;
  }
}

function renderTable(rows) {
  const thead = document.querySelector("#sheetTable thead");
  const tbody = document.querySelector("#sheetTable tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";
  
  if (rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="100%" style="text-align:center;padding:50px;">Tidak ada data</td></tr>';
    return;
  }
  
  // Header
  const header = document.createElement("tr");
  const maxCols = Math.max(...rows.map(row => row.length));
  
  for (let i = 0; i < maxCols; i++) {
    const th = document.createElement("th");
    th.textContent = rows[0][i] || `Kolom ${i + 1}`;
    th.onclick = () => sortTable(i);
    if (currentSort.index === i) {
      th.classList.add(currentSort.asc ? "sorted-asc" : "sorted-desc");
    }
    header.appendChild(th);
  }
  thead.appendChild(header);

  // Body
  rows.slice(1).forEach((row, index) => {
    const tr = document.createElement("tr");
    for (let i = 0; i < maxCols; i++) {
      const td = document.createElement("td");
      let cellValue = row[i] || '';
      
      // Format numbers for better display
      if (i >= 2 && i <= 3) { // Kolom C dan D (Stocked dan Empty Racking)
        const numValue = parseFloat(cellValue);
        if (!isNaN(numValue)) {
          cellValue = numValue.toLocaleString('id-ID');
        }
      }
      
      td.textContent = cellValue;
      tr.appendChild(td);
    }
    
    tr.onclick = () => {
      // Remove previous selection
      document.querySelectorAll("#sheetTable tbody tr").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");
      
      // Update selected row index
      selectedRowIndex = index;
      
      // Update charts with selected row data
      createCharts(allRows, row);
    };
    
    tbody.appendChild(tr);
  });
  
  updateSubtotals(rows);
}

function sortTable(columnIndex) {
  if (columnIndex === currentSort.index) {
    currentSort.asc = !currentSort.asc;
  } else {
    currentSort = { index: columnIndex, asc: true };
  }
  
  const rows = [...allRows];
  const header = rows.shift();
  
  rows.sort((a, b) => {
    const va = a[columnIndex] || '';
    const vb = b[columnIndex] || '';
    const na = parseFloat(va);
    const nb = parseFloat(vb);
    
    if (!isNaN(na) && !isNaN(nb)) {
      return currentSort.asc ? na - nb : nb - na;
    }
    return currentSort.asc ? va.toString().localeCompare(vb.toString()) : vb.toString().localeCompare(va.toString());
  });
  
  const sortedRows = [header, ...rows];
  renderTable(sortedRows);
  
  // Reset selection after sorting
  selectedRowIndex = -1;
  createCharts(sortedRows);
}

function applyFilters() {
  const search = document.getElementById("searchBox").value.toLowerCase();
  const filter = document.getElementById("filterC").value;
  
  const filtered = allRows.filter((row, index) => {
    if (index === 0) return true;
    
    const searchMatch = row.some(cell => 
      cell && cell.toString().toLowerCase().includes(search)
    );
    
    // Filter berdasarkan kolom A (Warehouse Location)
    const filterMatch = !filter || (row[0] && row[0].toString() === filter);
    
    return searchMatch && filterMatch;
  });
  
  renderTable(filtered);
  updateSubtotals(filtered);
  createCharts(filtered);
  
  // Reset selection after filtering
  selectedRowIndex = -1;
}

function fillFilter(rows) {
  const select = document.getElementById("filterC");
  select.innerHTML = "<option value=''>-- Semua Lokasi Gudang --</option>";
  
  if (rows.length > 1) {
    // Ambil data dari kolom A (Warehouse Location)
    const values = [...new Set(rows.slice(1).map(row => row[0]).filter(val => val))];
    values.sort(); // Sort alphabetically
    values.forEach(value => {
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  }
}

function exportTable() {
  try {
    const csv = Papa.unparse(allRows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "kapasitas_gudang_" + new Date().toISOString().slice(0,10) + ".csv";
    link.click();
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Export error:', error);
    alert('Error saat mengekspor data: ' + error.message);
  }
}

function printTable() {
  window.print();
}

function setStatus(status, text) {
  const span = document.querySelector("#status span");
  const statusText = document.getElementById("statusText");
  
  span.className = status === "connected" ? "connected" : 
                   status === "loading" ? "loading" : "disconnected";
  statusText.textContent = text;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  updateBreadcrumbDate();
  loadSheet();
  
  // Update date every minute
  setInterval(updateBreadcrumbDate, 60000);
  
  // Add click listener to clear selection when clicking outside table
  document.addEventListener('click', function(e) {
    if (!e.target.closest('#sheetTable') && !e.target.closest('.chart-container')) {
      const selectedRows = document.querySelectorAll("#sheetTable tbody tr.selected");
      if (selectedRows.length > 0) {
        selectedRows.forEach(row => row.classList.remove("selected"));
        selectedRowIndex = -1;
        createCharts(allRows); // Show all data
      }
    }
  });
});

// Global function access
window.goBackToDashboard = goBackToDashboard;
window.loadSheet = loadSheet;
window.applyFilters = applyFilters;
window.exportTable = exportTable;
window.printTable = printTable;
</script>
</body>
</html>
