<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard GSheet</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:0; background:#eef2f7; }
    header {
      display:flex;
      align-items:center;
      justify-content:flex-start;   /* tombol lebih ke kiri */
      background:#ffffff;           /* header putih */
      padding:12px 20px;
      color:#2c3e50;                /* teks gelap */
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .logo { display:flex; align-items:center; margin-right:40px; }
    .logo img { width:90px; height:50px; margin-right:10px; border-radius:8px; }
    .logo-text { display:flex; flex-direction:column; line-height:1.2; }
    .logo-text strong { font-size:16px; }
    .logo-text span { font-size:12px; opacity:0.7; }
    .controls { display:flex; gap:8px; align-items:center; }
    button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:13px; }
    button.export { background:#27ae60; color:white; }
    button.print { background:#2980b9; color:white; }
    button.refresh { background:#f39c12; color:white; }
    button:hover { opacity:0.85; }
    .status { display:flex; align-items:center; font-size:13px; margin-left:10px; }
    .status span { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:5px; }
    .connected{background:#2ecc71;} .disconnected{background:#e74c3c;} .loading{background:#f1c40f;}
    .filters{margin:20px;display:flex;gap:10px;flex-wrap:wrap;}
    input[type=text]{padding:6px 10px;border:1px solid #ccc;border-radius:6px;flex:1;}
    select{padding:6px;border-radius:6px;}
    .table-container{margin:20px;background:white;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow-x:auto;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}
    th{background:#2c3e50;color:white;cursor:pointer;}
    th.sorted-asc::after{content:" ▲";} th.sorted-desc::after{content:" ▼";}
    tr:nth-child(even){background:#f9f9f9;}
    .totals{margin-top:12px;font-weight:bold;font-size:15px;text-align:right;color:#2c3e50;}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
      <div class="logo-text">
        <strong>Warehouse Yogya</strong>
        <span>Update Stock Raw Material & Packaging</span>
      </div>
    </div>
    <div class="controls">
      <button class="export" onclick="exportTable()">⬇ Export</button>
      <button class="print" onclick="printTable()">🖨 Print</button>
      <button class="refresh" onclick="loadSheet()">🔄 Refresh Data</button>
      <div class="status" id="status">
        <span class="disconnected"></span><span id="statusText">Disconnected</span>
      </div>
    </div>
  </header>

  <div class="filters">
    <input type="text" id="searchBox" placeholder="🔍 Search..." oninput="applyFilters()">
    <select id="filterC" onchange="applyFilters()">
      <option value="">-- Filter Item ID --</option>
    </select>
    <select id="filterE" onchange="applyFilters()">
      <option value="">-- Filter Kategory--</option>
    </select>
  </div>

  <div class="table-container">
    <table id="sheetTable">
      <thead></thead>
      <tbody></tbody>
    </table>
    <div class="totals" id="totalQtyH">Total Pcs: 0</div>
<div class="totals" id="totalQtyI">Total Stock kgs/Roll/Meter/Ltr: 0</div>


<script>
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSxhDEkbXTioPrWkbvxRrOp27fQk_OkCKpmiZ5x-qyOxxtVHXKNfNyXkpmMY1MWNJANbd_gbPpz8D3/pub?gid=1599234092&single=true&output=csv";
let allRows = [];
let currentSort = { index: -1, asc: true };

async function loadSheet() {
  setStatus("loading","Loading...");
  try {
    const response = await fetch(sheetUrl + "&cacheBust=" + Date.now());
    if(!response.ok) throw new Error("Fetch gagal");
    const csvText = await response.text();
    const parsed = Papa.parse(csvText,{skipEmptyLines:true});
    allRows = parsed.data;
    renderTable(allRows);
    fillFilter(allRows);
    setStatus("connected","Connected");
  } catch(err) {
    console.error(err);
    setStatus("disconnected","Disconnected");
  }
}

function renderTable(rows){
  let thead=document.querySelector("#sheetTable thead");
  let tbody=document.querySelector("#sheetTable tbody");
  thead.innerHTML=""; tbody.innerHTML="";

  let headerRow=document.createElement("tr");
  rows[0].forEach((h,i)=>{
    let th=document.createElement("th");
    th.textContent=h;
    th.onclick=()=>sortTable(i);
    if(currentSort.index===i) th.classList.add(currentSort.asc?"sorted-asc":"sorted-desc");
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  let totalH=0, totalI=0;
  rows.slice(1).forEach(r=>{
    let tr=document.createElement("tr");
    r.forEach(c=>{
      let td=document.createElement("td"); td.textContent=c; tr.appendChild(td);
    });
    tbody.appendChild(tr);

    let valH=parseFloat(r[7]); if(!isNaN(valH)) totalH+=valH;
    let valI=parseFloat(r[8]); if(!isNaN(valI)) totalI+=valI;
  });
  document.getElementById("totalQtyH").textContent = "Total Pcs: " + totalH.toLocaleString();
document.getElementById("totalQtyI").textContent = "Total Stock kgs/Roll/Meter/Ltr: " + totalI.toLocaleString();
}

function sortTable(index){
  let rows=[...allRows];
  if(index===currentSort.index) currentSort.asc=!currentSort.asc;
  else currentSort={index,asc:true};
  let header=rows.shift();
  rows.sort((a,b)=>{
    let va=a[index], vb=b[index];
    let na=parseFloat(va), nb=parseFloat(vb);
    if(!isNaN(na)&&!isNaN(nb)) return currentSort.asc?na-nb:nb-na;
    return currentSort.asc?va.localeCompare(vb):vb.localeCompare(va);
  });
  renderTable([header,...rows]);
}

function applyFilters(){
  let search=document.getElementById("searchBox").value.toLowerCase();
  let filterC=document.getElementById("filterC").value;
  let filterE=document.getElementById("filterE").value;
  let filtered=allRows.filter((r,idx)=>{
    if(idx===0) return true;
    let matchSearch=r.some(c=>c.toLowerCase().includes(search));
    let matchC=!filterC||r[2]===filterC;
    let matchE=!filterE||r[4]===filterE;
    return matchSearch && matchC && matchE;
  });
  renderTable(filtered);
}

function fillFilter(rows){
  let selectC=document.getElementById("filterC");
  let selectE=document.getElementById("filterE");
  let valuesC=[...new Set(rows.slice(1).map(r=>r[2]))];
  let valuesE=[...new Set(rows.slice(1).map(r=>r[4]))];
  selectC.innerHTML="<option value=''>-- Filter Item ID --</option>";
  valuesC.forEach(v=>{if(v){let o=document.createElement("option");o.value=v;o.textContent=v;selectC.appendChild(o);}});
  selectE.innerHTML="<option value=''>-- Filter Kategory --</option>";
  valuesE.forEach(v=>{if(v){let o=document.createElement("option");o.value=v;o.textContent=v;selectE.appendChild(o);}});
}

function exportTable(){
  let csv=Papa.unparse(allRows);
  let blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a"); a.href=url; a.download="data.csv"; a.click();
}
function printTable(){ window.print(); }
function setStatus(state,text){
  let span=document.querySelector("#status span");
  span.className="";
  span.classList.add(state==="connected"?"connected":state==="loading"?"loading":"disconnected");
  document.getElementById("statusText").textContent=text;
}
loadSheet();
</script>
</body>
</html>
