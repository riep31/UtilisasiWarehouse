<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Utilisasi Warehouse</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family:'Segoe UI',Tahoma,sans-serif; margin:0; background:#eef2f7; display:flex; transition:0.3s; }

    /* Sidebar */
    .sidebar {
      width:220px; background:#2c3e50; color:white; min-height:100vh;
      display:flex; flex-direction:column; padding:20px 10px;
      box-shadow:2px 0 6px rgba(0,0,0,0.2);
      position:relative; transition:transform 0.3s ease-in-out;
      z-index:1000;
    }
    .sidebar.collapsed { transform:translateX(-220px); }
    .sidebar h2 { font-size:16px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px; }
    .sidebar button {
      background:none; border:none; color:white; text-align:left; padding:10px 15px; border-radius:6px; cursor:pointer;
      font-size:14px; margin-bottom:6px; transition:0.3s;
    }
    .sidebar button:hover, .sidebar button.active { background:#34495e; }

    /* Main */
    .main { flex:1; display:flex; flex-direction:column; transition:margin-left 0.3s ease-in-out; }
    .main.shifted { margin-left:-220px; }

    header {
      display:flex; align-items:center; justify-content:flex-start;
      background:#ffffff; padding:12px 20px; color:#2c3e50; box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .menu-toggle {
      font-size:22px; cursor:pointer; margin-right:15px; border:none; background:none;
    }
    .logo { display:flex; align-items:center; margin-right:20px; flex-shrink:0; }
    .logo img { width:70px; height:40px; margin-right:10px; border-radius:8px; }
    .logo-text { display:flex; flex-direction:column; line-height:1.2; }
    .logo-text strong { font-size:14px; }
    .logo-text span { font-size:11px; opacity:0.7; }
    .controls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    button.ctrl { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
    .export{background:#27ae60;} .print{background:#2980b9;} .refresh{background:#f39c12;}
    .status { display:flex; align-items:center; font-size:11px; margin-left:6px; }
    .status span { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; }
    .connected{background:#2ecc71;} .disconnected{background:#e74c3c;} .loading{background:#f1c40f;}

    .filters{margin:15px;display:flex;gap:8px;flex-wrap:wrap;}
    input[type=text]{padding:6px 8px;border:1px solid #ccc;border-radius:6px;flex:1; background:#f8f8f8;}
    select{padding:6px;border-radius:6px;background:#f8f8f8;}

    /* Tabel */
    .table-container{margin:15px;background:white;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;}
    th{background:#34495e;color:white;cursor:pointer;}
    th.sorted-asc::after{content:" ▲";} th.sorted-desc::after{content:" ▼";}
    tr:nth-child(even){background:#f9f9f9;}
    tr:hover { background:#dfe9f3; cursor:pointer; }
    th:first-child { background:#34495e; color:white; }
    .totals{margin-top:8px;font-weight:bold;font-size:13px;text-align:right;color:#2c3e50;}

    /* ✅ Chart section */
    .charts { display:flex; flex-wrap:wrap; gap:20px; margin:15px; }
    .chart-card { background:white; border-radius:12px; padding:15px; flex:1; min-width:250px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
    .chart-card h4 { margin-bottom:10px; font-size:14px; color:#2c3e50; }
    canvas { max-height:180px !important; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>📑 Menu</h2>
    <button onclick="switchSheet(0)" class="active">Raw Material & Packaging</button>
    <button onclick="switchSheet(1)">Finish Goods</button>
  </div>

  <!-- Main Content -->
  <div class="main" id="main">
    <header>
      <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
      <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
        <div class="logo-text">
          <strong>Raw Material & Packaging</strong>
          <span>Update Stock Raw Material & Packaging</span>
        </div>
      </div>
      <div class="controls">
        <button class="ctrl export" onclick="exportTable()">⬇ Export</button>
        <button class="ctrl print" onclick="printTable()">🖨 Print</button>
        <button class="ctrl refresh" onclick="loadSheet()">🔄 Refresh Data</button>
        <div class="status" id="status">
          <span class="disconnected"></span><span id="statusText">Disconnected</span>
        </div>
      </div>
    </header>

    <!-- ✅ Mini Charts -->
    <div class="charts">
      <div class="chart-card">
        <h4>Kapasitas Gudang (%)</h4>
        <canvas id="capacityChart"></canvas>
      </div>
      <div class="chart-card">
        <h4>Racking Status</h4>
        <canvas id="rackingChart"></canvas>
      </div>
    </div>

    <!-- ✅ Tabel kecil (Sheet 3) -->
    <div class="table-container">
      <h4>📊 Data Kapasitas Gudang</h4>
      <table id="miniTable"><thead></thead><tbody></tbody></table>
    </div>

    <!-- Tabel utama -->
    <div class="filters">
      <input type="text" id="searchBox" placeholder="🔍 Search..." oninput="applyFilters()">
      <select id="filterC" onchange="applyFilters()"><option value="">-- Filter --</option></select>
    </div>
    <div class="table-container">
      <table id="sheetTable"><thead></thead><tbody></tbody></table>
    </div>
  </div>

<script>
const sheetUrls = [
   "https://docs.google.com/spreadsheets/d/e/2PACX-1vTSxhDEkbXTioPrWkbvxRrOp27fQk_OkCKpmiZ5x-qyOxxtVHXKNfNyXkpmMY1MWNJANbd_gbPpz8D3/pub?gid=1599234092&single=true&output=csv",
   "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOViOi6H-pEujdwYvV9XHIpqMNbtrjEayK5Ri6uPNN31XJ6UVnhAlKb9vxyw2z4iebB3KbqyMNLV0Z/pub?gid=1311215156&single=true&output=csv",
   "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOViOi6H-pEujdwYvV9XHIpqMNbtrjEayK5Ri6uPNN31XJ6UVnhAlKb9vxyw2z4iebB3KbqyMNLV0Z/pub?gid=1101669529&single=true&output=csv"
];

const sheetTitles = [
  { title: "Raw Material & Packaging", subtitle: "Update Stock Raw Material & Packaging" },
  { title: "Finish Goods", subtitle: "Update Stock Barang Jadi" }
];

let activeSheet = 0;
let allRows = [];
let miniRows = [];
let currentSort = { index: -1, asc: true };
let capacityChart, rackingChart;

function toggleSidebar(){
  const sidebar=document.getElementById("sidebar");
  if(window.innerWidth<=768){
    sidebar.classList.toggle("show");
  }else{
    sidebar.classList.toggle("collapsed");
    document.getElementById("main").classList.toggle("shifted");
  }
}
function switchSheet(index){
  activeSheet=index;
  document.querySelectorAll(".sidebar button").forEach((btn,i)=>btn.classList.toggle("active",i===index));
  document.querySelector(".logo-text strong").textContent = sheetTitles[index].title;
  document.querySelector(".logo-text span").textContent = sheetTitles[index].subtitle;
  loadSheet();
}
async function loadSheet(){
  setStatus("loading","Loading...");
  try{
    // load sheet utama
    const res=await fetch(sheetUrls[activeSheet]+"&cacheBust="+Date.now());
    const csv=await res.text();
    const parsed=Papa.parse(csv,{skipEmptyLines:true});
    allRows=parsed.data;
    renderTable(allRows);
    fillFilter(allRows);
    updateCharts(allRows);

    // load sheet kecil (selalu sheet ke-3)
    const res2=await fetch(sheetUrls[2]+"&cacheBust="+Date.now());
    const csv2=await res2.text();
    const parsed2=Papa.parse(csv2,{skipEmptyLines:true});
    miniRows=parsed2.data;
    renderMiniTable(miniRows);

    setStatus("connected","Connected");
  }catch(e){ console.error(e); setStatus("disconnected","Disconnected"); }
}
function renderTable(rows){
  let thead=document.querySelector("#sheetTable thead");
  let tbody=document.querySelector("#sheetTable tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  let header=document.createElement("tr");
  rows[0].forEach((h,i)=>{
    let th=document.createElement("th"); th.textContent=h;
    th.onclick=()=>sortTable(i);
    if(currentSort.index===i) th.classList.add(currentSort.asc?"sorted-asc":"sorted-desc");
    header.appendChild(th);
  }); thead.appendChild(header);

  rows.slice(1).forEach(r=>{
    let tr=document.createElement("tr");
    r.forEach(c=>{ let td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
    tbody.appendChild(tr);
  });
}
function renderMiniTable(rows){
  let thead=document.querySelector("#miniTable thead");
  let tbody=document.querySelector("#miniTable tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  let header=document.createElement("tr");
  rows[0].forEach(h=>{ let th=document.createElement("th"); th.textContent=h; header.appendChild(th); });
  thead.appendChild(header);

  rows.slice(1).forEach((r,i)=>{
    let tr=document.createElement("tr");
    r.forEach(c=>{ let td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
    tr.onclick=()=>updateCharts([rows[0],r]); // klik baris → update chart 1 row
    tbody.appendChild(tr);
  });
}
function updateCharts(rows){
  if(rows.length < 2) return;
  let headers = rows[0];
  let locIdx = headers.indexOf("Warehouse Location");
  let stockedIdx = headers.indexOf("Stocked Racking Percent");
  let emptyIdx = headers.indexOf("Empty Racking Percent");
  if(locIdx<0||stockedIdx<0||emptyIdx<0) return;

  let labels = [];
  let stocked = [];
  let empty = [];
  rows.slice(1).forEach(r=>{
    labels.push(r[locIdx]);
    stocked.push(parseFloat(r[stockedIdx]||0));
    empty.push(parseFloat(r[emptyIdx]||0));
  });

  if(capacityChart) capacityChart.destroy();
  capacityChart = new Chart(document.getElementById("capacityChart"), {
    type:"bar",
    data:{ labels, datasets:[
      { label:"Stocked %", data:stocked, backgroundColor:"#3498db" },
      { label:"Empty %", data:empty, backgroundColor:"#95a5a6" }
    ]},
    options:{ responsive:true, plugins:{legend:{position:"bottom"}}, scales:{x:{stacked:true},y:{stacked:true,max:100}} }
  });

  let totalStocked = stocked.reduce((a,b)=>a+b,0)/stocked.length;
  let totalEmpty = empty.reduce((a,b)=>a+b,0)/empty.length;
  if(rackingChart) rackingChart.destroy();
  rackingChart = new Chart(document.getElementById("rackingChart"), {
    type:"doughnut",
    data:{ labels:["Stocked","Empty"], datasets:[{ data:[totalStocked,totalEmpty], backgroundColor:["#27ae60","#e74c3c"] }] },
    options:{ responsive:true, plugins:{legend:{position:"bottom"}} }
  });
}
function sortTable(i){
  let rows=[...allRows]; if(i===currentSort.index) currentSort.asc=!currentSort.asc; else currentSort={index:i,asc:true};
  let header=rows.shift();
  rows.sort((a,b)=>{
    let va=a[i],vb=b[i]; let na=parseFloat(va), nb=parseFloat(vb);
    if(!isNaN(na)&&!isNaN(nb)) return currentSort.asc?na-nb:nb-na;
    return currentSort.asc?va.localeCompare(vb):vb.localeCompare(va);
  });
  renderTable([header,...rows]);
}
function applyFilters(){
  let search=document.getElementById("searchBox").value.toLowerCase();
  let fC=document.getElementById("filterC").value;
  let filtered=allRows.filter((r,i)=>{
    if(i===0)return true;
    let s=r.some(c=>c.toLowerCase().includes(search));
    let mC=!fC||r[1]===fC;
    return s && mC;
  });
  renderTable(filtered);
  updateCharts(filtered);
}
function fillFilter(rows){
  let sc=document.getElementById("filterC");
  sc.innerHTML="<option value=''>-- Filter --</option>";
  let vals=[...new Set(rows.slice(1).map(r=>r[1]))];
  vals.forEach(v=>{if(v){let o=document.createElement("option");o.value=v;o.textContent=v;sc.appendChild(o);}});
}
function exportTable(){ let csv=Papa.unparse(allRows); let blob=new Blob([csv],{type:"text/csv"}); let url=URL.createObjectURL(blob); let a=document.createElement("a"); a.href=url; a.download="data.csv"; a.click(); }
function printTable(){ window.print(); }
function setStatus(st,t){ let span=document.querySelector("#status span"); span.className=st==="connected"?"connected":st==="loading"?"loading":"disconnected"; document.getElementById("statusText").textContent=t; }

loadSheet();
</script>
</body>
</html>
